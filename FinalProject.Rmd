---
title: "Final Project"
author: "Ashley L. Miller"
date: "1/28/2019"
output:
  html_document:
    theme: spacelab
    toc: yes
    toc_depth: 4
    toc_float: yes
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}

# set knitr options
knitr::opts_chunk$set(echo = TRUE,
                      message = FALSE,
                      warning = FALSE,
                      fig.width = 7.5,
                      fig.height = 4.0)

# load packages
library(rio)
library(here)
library(tidyverse)
library(magrittr)
library(ggforce)
library(rcartocolor)
library(cowplot)


# disable scientific notation
options(scipen = 999)

```

The following dataset is de-identified and already hosted on Github. The data come from one of my recent publications (Experiment 1; Miller, Gross, & Unsworth, 2019). In this paper, pupil dilation was used as an online indicator of the intensity of attention to determine whether variation in attention at encoding relates to individual differences in working memory capacity (WMC) and long-term memory (LTM) performance. Participants (*N* = 138) completed a battery of complex span working memory tasks, followed by a delayed free recall task while pupil dilation was simultaneously recorded.

```{r load_data}

data <- import(here("data", "DeIntentifiedJML2019Data_Exp1.sav"),
               setclass = "tibble") %>% 
  characterize() %>%
  janitor::clean_names()

```

```{r tidy_rename}

#select variables of interest for pupil data
pupil_data <- data %>%
  select(-sp1_acc:-symspan, 
         -ineffective:-recency_recall,
         -baseline_pupil_mean:-tepr_recency)

#Cam's efficient method to rename variables
pupil_data %<>%
  rename_at(
    vars(starts_with("ebin")),
    funs(
      paste(
        str_extract(., "w\\d{1,2}"),
        "_",
        str_extract(., "bin\\d{1,2}"),
        sep = "")))

```

```{r rename_bad, include=FALSE, eval=FALSE}

#Note that Cam's method of renaming variables does so in 10 lines, compared to the following:

#pupil_data %<>%
 # rename(w1_bin1 = ebin1w1pt4_mean,
  #       w1_bin2 = ebin2w1pt4_mean,
   #      w1_bin3 = ebin3w1pt4_mean,
    #     w1_bin4 = ebin4w1pt4_mean,
     #    w1_bin5 = ebin5w1pt4_mean,
      #   w1_bin6 = ebin6w1pt4_mean,
       #  w1_bin7 = ebin7w1pt4_mean,
        # w1_bin8 = ebin8w1pt4_mean,
         #w1_bin9 = ebin9w1pt4_mean,
         #w1_bin10 = ebin10w1pt4_mean,
         #w1_bin11 = ebin11w1pt4_mean,
         #w1_bin12 = ebin12w1pt4_mean,
         #w1_bin13 = ebin13w1pt4_mean,
         #w1_bin14 = ebin14w1pt4_mean,
         #w1_bin15 = ebin15w1pt4_mean)

#pupil_data %<>%
 # rename(w2_bin1 = ebin1w2pt4_mean,
  #       w2_bin2 = ebin2w2pt4_mean,
   #      w2_bin3 = ebin3w2pt4_mean,
    #     w2_bin4 = ebin4w2pt4_mean,
     #    w2_bin5 = ebin5w2pt4_mean,
      #   w2_bin6 = ebin6w2pt4_mean,
       #  w2_bin7 = ebin7w2pt4_mean,
        # w2_bin8 = ebin8w2pt4_mean,
         #w2_bin9 = ebin9w2pt4_mean,
         #w2_bin10 = ebin10w2pt4_mean,
         #w2_bin11 = ebin11w2pt4_mean,
         #w2_bin12 = ebin12w2pt4_mean,
         #w2_bin13 = ebin13w2pt4_mean,
         #w2_bin14 = ebin14w2pt4_mean,
         #w2_bin15 = ebin15w2pt4_mean)

#pupil_data %<>%
 # rename(w3_bin1 = ebin1w3pt4_mean,
  #       w3_bin2 = ebin2w3pt4_mean,
   #      w3_bin3 = ebin3w3pt4_mean,
    #     w3_bin4 = ebin4w3pt4_mean,
     #    w3_bin5 = ebin5w3pt4_mean,
      #   w3_bin6 = ebin6w3pt4_mean,
       #  w3_bin7 = ebin7w3pt4_mean,
        # w3_bin8 = ebin8w3pt4_mean,
         #w3_bin9 = ebin9w3pt4_mean,
         #w3_bin10 = ebin10w3pt4_mean,
         #w3_bin11 = ebin11w3pt4_mean,
         #w3_bin12 = ebin12w3pt4_mean,
         #w3_bin13 = ebin13w3pt4_mean,
         #w3_bin14 = ebin14w3pt4_mean,
         #w3_bin15 = ebin15w3pt4_mean)

#pupil_data %<>%
 # rename(w4_bin1 = ebin1w4pt4_mean,
  #       w4_bin2 = ebin2w4pt4_mean,
   #      w4_bin3 = ebin3w4pt4_mean,
    #     w4_bin4 = ebin4w4pt4_mean,
     #    w4_bin5 = ebin5w4pt4_mean,
      #   w4_bin6 = ebin6w4pt4_mean,
       #  w4_bin7 = ebin7w4pt4_mean,
        # w4_bin8 = ebin8w4pt4_mean,
         #w4_bin9 = ebin9w4pt4_mean,
         #w4_bin10 = ebin10w4pt4_mean,
         #w4_bin11 = ebin11w4pt4_mean,
         #w4_bin12 = ebin12w4pt4_mean,
         #w4_bin13 = ebin13w4pt4_mean,
         #w4_bin14 = ebin14w4pt4_mean,
         #w4_bin15 = ebin15w4pt4_mean)

#pupil_data %<>%
 # rename(w5_bin1 = ebin1w5pt4_mean,
  #       w5_bin2 = ebin2w5pt4_mean,
   #      w5_bin3 = ebin3w5pt4_mean,
    #     w5_bin4 = ebin4w5pt4_mean,
     #    w5_bin5 = ebin5w5pt4_mean,
      #   w5_bin6 = ebin6w5pt4_mean,
       #  w5_bin7 = ebin7w5pt4_mean,
        # w5_bin8 = ebin8w5pt4_mean,
         #w5_bin9 = ebin9w5pt4_mean,
         #w5_bin10 = ebin10w5pt4_mean,
         #w5_bin11 = ebin11w5pt4_mean,
         #w5_bin12 = ebin12w5pt4_mean,
         #w5_bin13 = ebin13w5pt4_mean,
         #w5_bin14 = ebin14w5pt4_mean,
         #w5_bin15 = ebin15w5pt4_mean)

#pupil_data %<>%
 # rename(w6_bin1 = ebin1w6pt4_mean,
  #       w6_bin2 = ebin2w6pt4_mean,
   #      w6_bin3 = ebin3w6pt4_mean,
    #     w6_bin4 = ebin4w6pt4_mean,
     #    w6_bin5 = ebin5w6pt4_mean,
      #   w6_bin6 = ebin6w6pt4_mean,
       #  w6_bin7 = ebin7w6pt4_mean,
        # w6_bin8 = ebin8w6pt4_mean,
         #w6_bin9 = ebin9w6pt4_mean,
         #w6_bin10 = ebin10w6pt4_mean,
         #w6_bin11 = ebin11w6pt4_mean,
         #w6_bin12 = ebin12w6pt4_mean,
         #w6_bin13 = ebin13w6pt4_mean,
         #w6_bin14 = ebin14w6pt4_mean,
         #w6_bin15 = ebin15w6pt4_mean)

#pupil_data %<>%
 # rename(w7_bin1 = ebin1w7pt4_mean,
  #       w7_bin2 = ebin2w7pt4_mean,
   #      w7_bin3 = ebin3w7pt4_mean,
    #     w7_bin4 = ebin4w7pt4_mean,
     #    w7_bin5 = ebin5w7pt4_mean,
      #   w7_bin6 = ebin6w7pt4_mean,
       #  w7_bin7 = ebin7w7pt4_mean,
        # w7_bin8 = ebin8w7pt4_mean,
         #w7_bin9 = ebin9w7pt4_mean,
         #w7_bin10 = ebin10w7pt4_mean,
         #w7_bin11 = ebin11w7pt4_mean,
         #w7_bin12 = ebin12w7pt4_mean,
         #w7_bin13 = ebin13w7pt4_mean,
         #w7_bin14 = ebin14w7pt4_mean,
         #w7_bin15 = ebin15w7pt4_mean)

#pupil_data %<>%
 # rename(w8_bin1 = ebin1w8pt4_mean,
  #       w8_bin2 = ebin2w8pt4_mean,
   #      w8_bin3 = ebin3w8pt4_mean,
    #     w8_bin4 = ebin4w8pt4_mean,
     #    w8_bin5 = ebin5w8pt4_mean,
      #   w8_bin6 = ebin6w8pt4_mean,
       #  w8_bin7 = ebin7w8pt4_mean,
        # w8_bin8 = ebin8w8pt4_mean,
         #w8_bin9 = ebin9w8pt4_mean,
         #w8_bin10 = ebin10w8pt4_mean,
         #w8_bin11 = ebin11w8pt4_mean,
         #w8_bin12 = ebin12w8pt4_mean,
         #w8_bin13 = ebin13w8pt4_mean,
         #w8_bin14 = ebin14w8pt4_mean,
         #w8_bin15 = ebin15w8pt4_mean)

#pupil_data %<>%
 # rename(w9_bin1 = ebin1w9pt4_mean,
  #       w9_bin2 = ebin2w9pt4_mean,
   #      w9_bin3 = ebin3w9pt4_mean,
    #     w9_bin4 = ebin4w9pt4_mean,
     #    w9_bin5 = ebin5w9pt4_mean,
      #   w9_bin6 = ebin6w9pt4_mean,
       #  w9_bin7 = ebin7w9pt4_mean,
        # w9_bin8 = ebin8w9pt4_mean,
         #w9_bin9 = ebin9w9pt4_mean,
         #w9_bin10 = ebin10w9pt4_mean,
         #w9_bin11 = ebin11w9pt4_mean,
         #w9_bin12 = ebin12w9pt4_mean,
         #w9_bin13 = ebin13w9pt4_mean,
         #w9_bin14 = ebin14w9pt4_mean,
         #w9_bin15 = ebin15w9pt4_mean)

#pupil_data %<>%
 # rename(w10_bin1 = ebin1w10pt4_mean,
  #       w10_bin2 = ebin2w10pt4_mean,
   #      w10_bin3 = ebin3w10pt4_mean,
    #     w10_bin4 = ebin4w10pt4_mean,
     #    w10_bin5 = ebin5w10pt4_mean,
      #   w10_bin6 = ebin6w10pt4_mean,
       #  w10_bin7 = ebin7w10pt4_mean,
        # w10_bin8 = ebin8w10pt4_mean,
         #w10_bin9 = ebin9w10pt4_mean,
         #w10_bin10 = ebin10w10pt4_mean,
         #w10_bin11 = ebin11w10pt4_mean,
         #w10_bin12 = ebin12w10pt4_mean,
         #w10_bin13 = ebin13w10pt4_mean,
         #w10_bin14 = ebin14w10pt4_mean,
         #w10_bin15 = ebin15w10pt4_mean)
```

### Plot 1
#### First attempt to plot pupil diameter as a function of time point (bin) at encoding of each word
+ Fig. 4 in Miller, Gross, & Unsworth (2019).
    + **Identification of the intended audience:** Scientific community
    + **The intended message to be communicated:** When instructed to study a list of words, pupil diameter increases throughout the encoding period for each word. This increase in pupil dilation is believed to reflect an increase in the amount of attentional effort devoted to a given item.

```{r tidy_data_plot1}

plot1_data <- pupil_data %>%
  gather(key = word_bin, value = TEPR, w1_bin1:w10_bin15) %>%
  separate(word_bin, c("word", "bin"), sep = "_") %>%
  mutate(word = parse_number(word),
         bin = parse_number(bin)) %>%
  arrange(subject)

#glimpse(plot1_data)

```

```{r plot1, fig.height=3.5, fig.width=7, fig.align='center'}

plot1 <- plot1_data %>%
  group_by(bin) %>%
  summarise(mean_TEPR = mean(TEPR, na.rm = TRUE),
            sd_TEPR = sd(TEPR, na.rm = TRUE))

plot1 <- rbind(plot1, "1st" = c(0, 0, 0)) %>% #this just makes the line begin at x = 0 and y = 0
  ggplot(aes(x = bin, y = mean_TEPR)) +
    geom_smooth(color = "#2DDADA") +
    theme_minimal() +
    theme(axis.title = element_text(face = "bold"),
          plot.title = element_text(face = "bold"),
          plot.caption = element_text(hjust = 0)) +
      labs(caption = "Figure 1. Task evoked pupillary response across time of encoding period, which equated to a total of 3 seconds for 
each to-be-remembered word.",
           y = "Mean Pupillary Response (mm)",
           x = "Time (ms)") +
    scale_x_continuous(breaks = c(0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15),
                       labels = c("0", "200", "400", "600", "800", "1,000", "1,200", "1,400", "1,600", 
                                 "1,800", "2,000", "2,200", "2,400", "2,600", "2,800", "3,000"),
                       limits = c(0, NA))

ash_theme <- theme(panel.grid.major = element_line(colour = "gray30"), 
                   panel.grid.minor = element_line(colour = "gray30"), 
                   axis.text = element_text(colour = "gray80"), 
                   axis.text.x = element_text(colour = "gray80"), 
                   axis.text.y = element_text(colour = "gray80"),
                   axis.title = element_text(colour = "gray80"),
                   legend.text = element_text(colour = "gray80"), 
                   legend.title = element_text(colour = "gray80"), 
                   plot.subtitle = element_text(colour = "gray80"),
                   strip.text = element_text(colour = "gray80"),
                   panel.background = element_rect(fill = "gray10"),                     
                   plot.background = element_rect(fill = "gray10"), 
                   legend.background = element_rect(fill = NA, color = NA), 
                   plot.margin = margin(10, 10, b = 20, 10),
                   plot.caption = element_text(colour = "gray80", vjust = 1), 
                   plot.title = element_text(colour = "gray80"))

ash_theme2 <- theme(panel.grid.major = element_line(colour = "gray30"), 
                   panel.grid.minor = element_line(colour = "gray30"), 
                   axis.text = element_text(colour = "gray80"), 
                   axis.text.x = element_text(colour = "gray80"), 
                   axis.text.y = element_text(colour = "gray80"),
                   axis.title = element_text(colour = "gray80"),
                   legend.text = element_text(colour = "gray80"), 
                   legend.title = element_text(colour = "gray80"), 
                   plot.subtitle = element_text(colour = "gray80"),
                   strip.text = element_text(colour = "gray80"),
                   panel.background = element_rect(fill = "gray10"),                     
                   plot.background = element_rect(fill = "gray10"), 
                   legend.background = element_rect(fill = "gray10"), 
                   plot.margin = margin(10, 10, b = 20, 10),
                   plot.caption = element_text(colour = "gray80", vjust = 1), 
                   plot.title = element_text(colour = "gray80"))

plot1 <- plot1 + ash_theme

plot1

```

### Plot 2
#### First attempt to plot pupil diameter as a function of serial position for high WMC (*n* = 33) and low WMC (*n* = 31) individuals.
+ Fig. 5 in Miller, Gross, & Unsworth (2019)
    + **Identification of the intended audience:** Scientific community
    + **The intended message to be communicated:** Different patterns of pupil dilation across serial positions emerge based on one's working memory capacity (WMC). Namely, for high WMC individuals (*n* = 33), pupil diameter **increases** as each new word is introduced during the learning phase of the task. Alternatively, for low WMC individuals (*n* = 31), pupil diameter **decreases** as each new word is introducted during learning.
    
```{r tidy_data_plot2, fig.height=5, fig.width=6.5, fig.align='center'}

plot1_data$span_group <- factor(plot1_data$span_group, levels = c("Low", "Medium", "High"))

plot2 <- plot1_data %>%
  group_by(word, span_group) %>%
  summarise(mean_TEPR = mean(TEPR, na.rm = TRUE),
            sd_TEPR = sd(TEPR, na.rm = TRUE)) %>%
  ggplot(aes(x = word, y = mean_TEPR, color = span_group)) +
    geom_smooth(size = 1.5) +
    scale_color_carto_d(palette = "Burg") +
    theme_minimal() +
    theme(axis.title = element_text(face = "bold"),
          plot.title = element_text(face = "bold"),
          plot.caption = element_text(hjust = 0)) +
      labs(caption = "Figure 2. Pupillary response across serial positions for high working memory capacity (WMC) individuals 
(n = 33), medium WMC (n = 69) individuals, and low WMC (n = 31) individuals.",
           y = "Mean Pupillary Response (mm)",
           x = "Serial position",
           colour = "WMC") +
   scale_x_continuous(breaks = c(1, 2, 3, 4, 5, 6, 7, 8, 9, 10),
                       labels = c("1", "2", "3", "4", "5", "6", "7", "8", "9", "10")) 

plot2 <- plot2 + ash_theme

plot2

```

### Plot 3
#### First attempt to plot pupil diameter as a function of serial position and bin (time across encoding period) for low WMC (*n* = 31) and high WMC (*n* = 33) individuals. Serial position was broken down into Primacy (items 1–3), Mid (items 4–7), and Recency (items 8–10) for graphical purposes only.
+ Fig. 6 in Miller, Gross, & Unsworth (2019)
    + **Identification of the intended audience:** Scientific community
    + **The intended message to be communicated:** This figure essentially conveys the same information as the figure above. For high WMC individuals, pupil dilation continues to gradually increase throughout the encoding period for all serial positions, with primacy items (the first few words presented during list presentation; words 1-3) displaying smaller dilations than mid (words 4–7) and recency items (the last few words presented during list presentation; words 8–10). Conversely, low WMC individuals show moderate increases in dilation that appear to plateau near the middle of the encoding period. Moreover, pupil dilation appears to be largest for primacy items and smallest for recency items, despite a gradual increase in dilation for recency items.

```{r plot3_tidy1}

primacy <- plot1_data %>%
  filter(word < 4) %>%
  group_by(bin, span_group) %>%
  summarise(primacy_TEPR = mean(TEPR, na.rm = TRUE))

mid <- plot1_data %>%
  filter(word > 3,
         word < 8) %>%
  group_by(bin, span_group) %>%
  summarise(mid_TEPR = mean(TEPR, na.rm = TRUE))

recency <- plot1_data %>%
  filter(word > 7) %>%
  group_by(bin, span_group) %>%
  summarise(recency_TEPR = mean(TEPR, na.rm = TRUE))

```

```{r plot3}

plot3a <- ggplot(primacy, aes(x = bin, y = primacy_TEPR, color = span_group)) +
  geom_smooth() +
  scale_color_carto_d(palette = "Burg") +
  theme_minimal() +
  theme(axis.title = element_text(face = "bold"),
        axis.text.x = element_text(angle = 45, hjust = 1),
        plot.title = element_text(face = "bold"),
        plot.caption = element_text(hjust = 0),
        plot.subtitle = element_text(face = "bold", hjust = 0.5)) +
  labs(subtitle = "Primacy Items (Words 1-3)",
           y = "Mean Pupillary Response (mm)",
           x = "",
           colour = "WMC") +
  scale_x_continuous(breaks = c(0, 2, 4, 6, 8, 10, 12, 14),
                     labels = c("0", "400", "800", "1,200", "1,600", "2,000", "2,400","2,800"),
                     limits = c(0, NA)) +
  scale_y_continuous(breaks = c(-0.10, -0.05, 0.00, 0.05, 0.10, 0.15),
                     label = c("-0.10", "-0.05", "0.00", "0.05", "0.10", "0.15"),
                     limits = c(-0.10, 0.15))

plot3a <- plot3a + ash_theme 
plot3a <- plot3a + theme(legend.position = "none")

plot3b <- ggplot(mid, aes(x = bin, y = mid_TEPR, color = span_group)) +
  geom_smooth() +
  scale_color_carto_d(palette = "Burg") +
  theme_minimal() +
  theme(axis.title = element_text(face = "bold"),
        axis.text.x = element_text(angle = 45, hjust = 1),
        plot.title = element_text(face = "bold"),
        plot.caption = element_text(hjust = 0),
        plot.subtitle = element_text(face = "bold", hjust = 0.5)) +
  labs(subtitle = "Middle Items (Words 4-7)",
           y = "",
           x = "Time (ms)",
           colour = "WMC") +
  scale_x_continuous(breaks = c(0, 2, 4, 6, 8, 10, 12, 14),
                     labels = c("0", "400", "800", "1,200", "1,600", "2,000", "2,400","2,800"),
                     limits = c(0, NA)) +
  scale_y_continuous(breaks = c(-0.10, -0.05, 0.00, 0.05, 0.10, 0.15),
                     label = c("-0.10", "-0.05", "0.00", "0.05", "0.10", "0.15"),
                     limits = c(-0.10, 0.15))

plot3b <- plot3b + ash_theme
plot3b <- plot3b + theme(legend.position = "none")

plot3c <- ggplot(recency, aes(x = bin, y = recency_TEPR, color = span_group)) +
  geom_smooth() +
  scale_color_carto_d(palette = "Burg") +
  theme_minimal() +
  theme(axis.title = element_text(face = "bold"),
        axis.text.x = element_text(angle = 45, hjust = 1),
        plot.title = element_text(face = "bold"),
        plot.caption = element_text(hjust = 0),
        plot.subtitle = element_text(face = "bold", hjust = 0.5)) +
  labs(subtitle = "Recency Items (Words 8-10)",
        y = "",
        x = "",
        colour = "WMC") +
  scale_x_continuous(breaks = c(0, 2, 4, 6, 8, 10, 12, 14),
                     labels = c("0", "400", "800", "1,200", "1,600", "2,000", "2,400","2,800"),
                     limits = c(0, NA)) +
  scale_y_continuous(breaks = c(-0.10, -0.05, 0.00, 0.05, 0.10, 0.15),
                     label = c("-0.10", "-0.05", "0.00", "0.05", "0.10", "0.15"),
                     limits = c(-0.10, 0.15))

plot3c <- plot3c + ash_theme
plot3c <- plot3c + theme(legend.position = "none")

plot3 <- plot_grid(plot3a, plot3b, plot3c, labels = c("", "", ""), align = "h", nrow = 1) 

test <- plot2 + ash_theme2

grobs <- ggplotGrob(test)$grobs
legend <- grobs[[which(sapply(grobs, function(x) x$name) == "guide-box")]]

plot_grid(plot3, legend, ncol = 2, rel_widths = c(1, .1)) #still need to find a way to fill pannel around background???

```

